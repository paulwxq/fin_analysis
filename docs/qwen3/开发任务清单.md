# Qwen3 Chat Client 开发任务清单

## 项目概览

**目标**: 为MAF实现Qwen3原生Chat Client
**预计工作量**: 30小时
**开始日期**: 2026-01-29
**目标完成**: 2026-02-05

---

## Phase 1: 基础架构搭建 (4小时)

### Task 1.1: 依赖配置 (30分钟)

- [ ] 在 `pyproject.toml` 添加依赖
  ```toml
  dependencies = [
      "dashscope>=1.20.0",
  ]

  [project.optional-dependencies]
  dev = [
      "pytest>=8.0.0",
      "pytest-asyncio>=0.25.0",
      "pytest-mock>=3.15.0",
  ]
  ```
- [ ] 运行 `uv sync`
- [ ] 验证 `import dashscope` 可用

### Task 1.2: 文件框架创建 (30分钟)

- [ ] 创建 `qwen3/__init__.py`
- [ ] 创建 `qwen3/config.py` 并写入默认参数常量（含注释）
      - DEFAULT_MODEL_ID
      - DEFAULT_TEMPERATURE
      - DEFAULT_MAX_TOKENS
      - DEFAULT_TOP_P
      - DEFAULT_ENABLE_SEARCH
      - REQUEST_TIMEOUT_S
      - MAX_RETRIES
- [ ] 创建 `qwen3/qwen_options.py`
- [ ] 创建 `qwen3/exceptions.py`
- [ ] 创建 `qwen3/utils.py`
- [ ] 创建 `qwen3/qwen_client.py`
- [ ] 创建 `qwen3/qwen_vl_client.py`
- [ ] 创建 `qwen3/tests/__init__.py`
- [ ] 创建 `qwen3/examples/` 目录

### Task 1.3: 实现异常类 (1小时)

**文件**: `exceptions.py`

- [ ] 实现 `QwenAPIError`
- [ ] 实现 `ThinkingModeRequiresStreamError`
- [ ] 实现 `UnsupportedParameterError`
- [ ] 实现 `RateLimitError`
- [ ] 添加docstring

```python
class QwenAPIError(Exception):
    """DashScope API调用错误基类"""
    pass

class ThinkingModeRequiresStreamError(ValueError):
    """思考模式必须使用流式调用"""
    pass

class UnsupportedParameterError(ValueError):
    """模型不支持的参数"""
    pass

class RateLimitError(QwenAPIError):
    """API限流错误"""
    pass
```

### Task 1.4: 实现工具函数 (1小时)

**文件**: `utils.py`

- [ ] 实现 `map_finish_reason()`
  ```python
  def map_finish_reason(reason: Optional[str]) -> Optional[FinishReason]
  ```
- [ ] 实现 `extract_search_info()`
- [ ] 添加类型标注和docstring

### Task 1.5: 实现配置类 (1小时)

**文件**: `qwen_options.py`

- [ ] 实现 `QwenChatOptions` TypedDict
- [ ] 实现 `QwenVLChatOptions` TypedDict
- [ ] 添加字段说明注释

```python
from typing import TypedDict, NotRequired, Literal
from agent_framework import ChatOptions

class QwenChatOptions(ChatOptions):
    """Qwen文本模型配置"""
    enable_thinking: NotRequired[bool]
    enable_search: NotRequired[bool]
    seed: NotRequired[int]
    repetition_penalty: NotRequired[float]
    include_reasoning: NotRequired[bool]

class QwenVLChatOptions(ChatOptions):
    """Qwen视觉模型配置"""
    min_pixels: NotRequired[int]
    max_pixels: NotRequired[int]
```


## Phase 2: 推理模型实现 (8小时)

### Task 2.1: 基础类结构 (1小时)

**文件**: `qwen_client.py`

- [ ] 导入依赖
- [ ] 实现 `QwenChatClient` 类定义
- [ ] 实现 `__init__` 方法
- [ ] 实现 `_convert_messages` 方法

### Task 2.2: 非流式响应 (2小时)

- [ ] 实现 `_build_request_params` 方法
- [ ] 实现 `_inner_get_response` 方法
- [ ] 添加错误处理
- [ ] 添加思考模式检测（抛出异常）

### Task 2.3: 流式响应 (3小时)

- [ ] 实现线程池异步适配器
- [ ] 实现 `_inner_get_streaming_response` 方法
- [ ] 处理 `reasoning_content` 字段
- [ ] 处理 `incremental_output` 设置
- [ ] 添加Token统计日志

### Task 2.4: 测试基础功能 (2小时)

- [ ] 编写基础对话测试
- [ ] 编写流式响应测试
- [ ] 编写错误处理测试
- [ ] 验证API调用正常

**测试用例**:
```python
@pytest.mark.asyncio
async def test_basic_chat():
    from agent_framework import TextContent  # 补充导入

    client = QwenChatClient(model_id="qwen-plus")
    # ✅ 使用标准格式 contents=[TextContent(...)]
    messages = [
        ChatMessage(
            role=Role.USER,
            contents=[TextContent(text="你好")]
        )
    ]
    response = await client.get_response(messages)
    assert response.messages
    assert response.messages[0].contents[0].text
```

---

## Phase 3: 视觉模型实现 (8小时)

### Task 3.1: 基础类结构 (1小时)

**文件**: `qwen_vl_client.py`

- [ ] 导入依赖
- [ ] 实现 `QwenVLChatClient` 类定义
- [ ] 实现 `__init__` 方法

### Task 3.2: 多模态转换 (3小时)

- [ ] 实现 `_process_content_item` 方法
  - [ ] 处理文本内容
  - [ ] 处理图片URL
  - [ ] 处理Base64图片
- [ ] 实现 `_convert_messages` 方法
- [ ] 添加健壮的类型检测

### Task 3.3: 非流式响应 (2小时)

- [ ] 实现 `_inner_get_response` 方法
- [ ] 使用 `MultiModalConversation.call`
- [ ] 处理返回的复杂结构
- [ ] 提取文本内容

### Task 3.4: 流式响应 (2小时)

- [ ] 实现 `_inner_get_streaming_response` 方法
- [ ] 复用线程池模式
- [ ] 处理增量内容

---

## Phase 4: 测试编写 (6小时)

### Task 4.1: 推理模型单元测试 (2小时)

**文件**: `tests/test_qwen_client.py`

- [ ] 测试消息格式转换
- [ ] 测试基础对话
- [ ] 测试流式响应
- [ ] 测试思考模式
- [ ] 测试联网搜索
- [ ] 测试错误处理
- [ ] 测试Token统计

### Task 4.2: 视觉模型单元测试 (2小时)

**文件**: `tests/test_qwen_vl_client.py`

- [ ] 测试多模态转换
- [ ] 测试图片URL输入
- [ ] 测试Base64输入
- [ ] 测试纯文本输入
- [ ] 测试不支持的参数

### Task 4.3: 集成测试 (2小时)

**文件**: `tests/test_integration.py`

- [ ] 测试与 `ChatAgent` 集成
- [ ] 测试中间件兼容性
- [ ] 测试多轮对话
- [ ] 测试混合模型工作流

**目标**: 测试覆盖率 > 80%

---

## Phase 5: 示例与文档 (4小时)

### Task 5.1: 编写示例代码 (2小时)

- [ ] `examples/basic_chat.py` - 基础对话
- [ ] `examples/thinking_mode.py` - 思考模式
- [ ] `examples/search_enhanced.py` - 联网搜索
- [ ] `examples/vision_analysis.py` - K线图分析

### Task 5.2: API文档 (1小时)

- [ ] 为所有公开类添加docstring
- [ ] 为所有公开方法添加参数说明
- [ ] 添加类型标注
- [ ] 生成API参考（可选）

### Task 5.3: 故障排查指南 (1小时)

- [ ] 更新 README.md
- [ ] 添加常见问题解答
- [ ] 添加调试技巧
- [ ] 添加性能优化建议

---

## 验收标准

### 功能验收

- [ ] ✅ qwen-plus 能在MAF中正常调用
- [ ] ✅ qwen3-vl-plus 能分析K线图
- [ ] ✅ 思考模式正确返回推理过程
- [ ] ✅ 联网搜索正确返回引用
- [ ] ✅ 流式输出无重复文本
- [ ] ✅ 所有参数正确传递
- [ ] ✅ 错误处理完善

### 质量验收

- [ ] ✅ 类型标注覆盖率 100%
- [ ] ✅ 单元测试覆盖率 > 80%
- [ ] ✅ 所有公开API有docstring
- [ ] ✅ 通过MyPy类型检查
- [ ] ✅ 通过pytest测试套件

### 集成验收

- [ ] ✅ 能与ChatAgent无缝集成
- [ ] ✅ 中间件自动生效
- [ ] ✅ 工具调用正常
- [ ] ✅ 多轮对话正常

### 文档验收

- [ ] ✅ README完整
- [ ] ✅ 至少4个可运行示例
- [ ] ✅ 故障排查指南
- [ ] ✅ API参考文档

---

## 风险管理

### 高风险项

| 风险 | 缓解措施 | 责任人 | 状态 |
|-----|---------|--------|------|
| DashScope API限流 | 实现重试机制 | 开发者 | 待处理 |
| 异步流式阻塞 | 线程池隔离 | 开发者 | 已规划 |

### 时间风险

如果Phase 2-3进展缓慢：
- **Plan B**: 先完成推理模型，视觉模型作为v2.0
- **Plan C**: 仅实现基础功能，高级特性后续迭代

---

## 进度跟踪

### 当前状态

- ✅ Phase 0: 需求评估完成
- ⏳ Phase 1: 待开始
- ⏳ Phase 2: 待开始
- ⏳ Phase 3: 待开始
- ⏳ Phase 4: 待开始
- ⏳ Phase 5: 待开始

### 里程碑

- [ ] **M1**: 基础架构完成 (Phase 1) - 目标: Day 1
- [ ] **M2**: 推理模型可用 (Phase 2) - 目标: Day 3
- [ ] **M3**: 视觉模型可用 (Phase 3) - 目标: Day 5
- [ ] **M4**: 测试通过 (Phase 4) - 目标: Day 6
- [ ] **M5**: 生产就绪 (Phase 5) - 目标: Day 7

---

## 下一步行动

### 今天 (2026-01-29)

1. [ ] **环境准备**
   - 在 `pyproject.toml` 添加 `dashscope` 依赖
   - 运行 `uv sync`
   - 验证 `DASHSCOPE_API_KEY` 设置

2. [ ] **开始Phase 1**
   - 创建所有文件框架
   - 实现 `exceptions.py`
   - 实现 `qwen_options.py`

### 本周目标

- [ ] 完成 Phase 1-2
- [ ] 推理模型能基础对话

### 下周目标

- [ ] 完成 Phase 3-5
- [ ] 所有测试通过
- [ ] 文档完善

---

## 检查清单

### 代码质量

- [ ] 所有函数有类型标注
- [ ] 所有公开API有docstring
- [ ] 遵循PEP 8代码规范
- [ ] 无 `# type: ignore` (除非必要)
- [ ] 无重复代码

### 测试质量

- [ ] 所有异步函数测试超时
- [ ] 所有异常路径有测试
- [ ] Mock所有外部API调用
- [ ] 测试用例有清晰描述

### 文档质量

- [ ] README可读性好
- [ ] 示例代码可运行
- [ ] 术语使用一致
- [ ] 中英文混排规范

---

**最后更新**: 2026-01-29
**下次审查**: 开始Phase 2时
