# æ–‡æ¡£ä¿®æ­£è®°å½• - æ€è€ƒæ¨¡å¼æµå¼çº¦æŸ

**ä¿®æ­£æ—¥æœŸ**: 2026-01-29
**ä¿®æ­£åŸå› **: å‘ç°ç¤ºä¾‹ä»£ç ä¸æŠ€æœ¯çº¦æŸç›¸äº’çŸ›ç›¾
**ä¸¥é‡ç¨‹åº¦**: é«˜ï¼ˆç¤ºä¾‹ä»£ç ä¼šç›´æ¥æŠ¥é”™ï¼‰
**å‘ç°è€…**: ç”¨æˆ·Code Review

---

## é—®é¢˜æè¿°

### å‘ç°çš„çŸ›ç›¾

ç”¨æˆ·å‘ç°æ–‡æ¡£ä¸­å­˜åœ¨**ç¤ºä¾‹ä»£ç ä¸æŠ€æœ¯çº¦æŸç›¸äº’çŸ›ç›¾**çš„ä¸¥é‡é—®é¢˜ï¼š

**çŸ›ç›¾ç‚¹1 - README.md ç¬¬318-336è¡Œ**ï¼š
- "å¯ç”¨æ€è€ƒæ¨¡å¼"ç¤ºä¾‹ä½¿ç”¨ `agent.run()`ï¼ˆéæµå¼è°ƒç”¨ï¼‰
- é…ç½®ä¸­è®¾ç½® `enable_thinking=True`
- **ç»“æœ**ï¼šè¿™æ®µä»£ç ä¼šç›´æ¥æŠ¥é”™ï¼

**çŸ›ç›¾ç‚¹2 - README.md ç¬¬417-429è¡Œ**ï¼š
- æ•…éšœæ’æŸ¥æ˜ç¡®è¯´æ˜ï¼š"æ€è€ƒæ¨¡å¼å¿…é¡»ä½¿ç”¨æµå¼å“åº”"
- é”™è¯¯ç¤ºä¾‹ï¼š`agent.run(query, enable_thinking=True)`  âŒ
- æ­£ç¡®ç¤ºä¾‹ï¼š`agent.run_stream(query, enable_thinking=True)`  âœ…

**æŠ€æœ¯ä¾æ®**ï¼ˆéœ€æ±‚è¯„ä¼°æ–‡æ¡£ç¬¬110è¡Œï¼‰ï¼š
> æ€è€ƒæ¨¡å¼å¿…é¡»æµå¼è°ƒç”¨ | éæµå¼ä¼šè¿”å›400é”™è¯¯ | åœ¨ `get_response` ä¸­æ£€æµ‹å¹¶æŠ›å‡ºå¼‚å¸¸

---

## æ ¹æœ¬åŸå› 

### DashScope APIçš„ç¡¬æ€§çº¦æŸ

æ ¹æ®DashScopeå®˜æ–¹APIæ–‡æ¡£å’Œå®é™…æµ‹è¯•ï¼š

```
å½“ enable_thinking=True æ—¶ï¼š
  - stream å‚æ•°å¿…é¡»ä¸º True
  - å¦åˆ™è¿”å› HTTP 400 é”™è¯¯
  - é”™è¯¯ä¿¡æ¯: "parameter.enable_thinking must be set to false for non-streaming calls"
```

**æŠ€æœ¯åŸå› **ï¼š
1. **æ€è€ƒè¿‡ç¨‹é•¿åº¦ä¸å¯æ§**ï¼šæ¨¡å‹å¯èƒ½ç”Ÿæˆæ•°åƒTokençš„æ€è€ƒå†…å®¹
2. **éæµå¼è¶…æ—¶é£é™©**ï¼šç­‰å¾…å®Œæ•´å“åº”å¯èƒ½å¯¼è‡´HTTPè¿æ¥è¶…æ—¶
3. **ç”¨æˆ·ä½“éªŒ**ï¼šæµå¼è¾“å‡ºè®©ç”¨æˆ·èƒ½å®æ—¶çœ‹åˆ°è¿›å±•ï¼Œè€Œéé•¿æ—¶é—´ç­‰å¾…

---

## ä¿®æ­£å†…å®¹

### 1. README.md - "å¯ç”¨æ€è€ƒæ¨¡å¼"ç¤ºä¾‹ âœ…

**ä¿®æ”¹ä½ç½®**: ç¬¬318-336è¡Œ

**ä¿®æ”¹å‰**ï¼ˆâŒ ä¼šæŠ¥é”™ï¼‰:
```python
### å¯ç”¨æ€è€ƒæ¨¡å¼

options = QwenChatOptions(
    enable_thinking=True,
    temperature=0.6
)

result = await agent.run(  # âŒ éæµå¼ - ä¼šè¿”å›400é”™è¯¯
    "è¯æ˜æ ¹å·2æ˜¯æ— ç†æ•°",
    additional_chat_options=options
)
```

**ä¿®æ”¹å**ï¼ˆâœ… æ­£ç¡®ï¼‰:
```python
### å¯ç”¨æ€è€ƒæ¨¡å¼

âš ï¸ **é‡è¦**ï¼šæ€è€ƒæ¨¡å¼å¿…é¡»ä½¿ç”¨æµå¼å“åº”ï¼Œå¦åˆ™ä¼šè¿”å›400é”™è¯¯ã€‚

options = QwenChatOptions(
    enable_thinking=True,
    temperature=0.6
)

# âœ… æ­£ç¡®ï¼šä½¿ç”¨æµå¼å“åº”
print("Assistant: ", end="", flush=True)
async for update in agent.run_stream(
    "è¯æ˜æ ¹å·2æ˜¯æ— ç†æ•°",
    additional_chat_options=options
):
    if update.text:
        print(update.text, end="", flush=True)
print()

**ä¸ºä»€ä¹ˆå¿…é¡»æµå¼ï¼Ÿ**
- æ€è€ƒè¿‡ç¨‹é•¿åº¦ä¸å¯æ§ï¼Œå¯èƒ½ç”Ÿæˆæ•°åƒToken
- éæµå¼è°ƒç”¨ä¼šå› è¶…æ—¶å¯¼è‡´è¿æ¥ä¸­æ–­
- DashScope APIå¼ºåˆ¶è¦æ±‚ `enable_thinking=True` æ—¶ `stream=True`
```

---

### 2. README.md - è‡ªå®šä¹‰Chat Clientä¼˜åŠ¿ç¤ºä¾‹ âœ…

**ä¿®æ”¹ä½ç½®**: ç¬¬88-104è¡Œ

**é—®é¢˜**ï¼šç¤ºä¾‹åŒæ—¶è®¾ç½®äº† `enable_thinking=True` å’Œä½¿ç”¨ `agent.run()`

**ä¿®æ”¹å‰**ï¼ˆâŒ ä¼šæŠ¥é”™ï¼‰:
```python
options = QwenChatOptions(
    enable_thinking=True,      # âŒ è®¾ç½®äº†æ€è€ƒæ¨¡å¼
    enable_search=True,
    temperature=0.7
)

result = await agent.run(      # âŒ ä½†ä½¿ç”¨äº†éæµå¼è°ƒç”¨
    "åˆ†æAè‚¡å¸‚åœºè¶‹åŠ¿",
    additional_chat_options=options
)
```

**ä¿®æ”¹å**ï¼ˆâœ… æ­£ç¡®ï¼‰:
```python
options = QwenChatOptions(
    enable_search=True,  # âœ… è”ç½‘æœç´¢ï¼ˆå¯ä»¥éæµå¼ï¼‰
    temperature=0.7
)

result = await agent.run(
    "åˆ†æAè‚¡å¸‚åœºè¶‹åŠ¿",
    additional_chat_options=options
)

# æ³¨æ„ï¼šå¦‚æœéœ€è¦å¯ç”¨æ€è€ƒæ¨¡å¼ï¼ˆenable_thinking=Trueï¼‰ï¼Œ
# å¿…é¡»ä½¿ç”¨ agent.run_stream() è€Œé agent.run()
```

---


**ä¿®æ”¹ä½ç½®**: ç¬¬406-412è¡Œ

**é—®é¢˜**ï¼šåªå±•ç¤ºäº†é…ç½®ï¼Œä½†æ²¡æœ‰å±•ç¤ºå¦‚ä½•ä½¿ç”¨ï¼ˆå®¹æ˜“è¯¯å¯¼ï¼‰

**ä¿®æ”¹å‰**ï¼ˆâš ï¸ ä¸å®Œæ•´ï¼‰:
```python

options = QwenChatOptions(
    enable_thinking=True,
)
# ... æ²¡æœ‰å±•ç¤ºå¦‚ä½•è°ƒç”¨
```

**ä¿®æ”¹å**ï¼ˆâœ… å®Œæ•´ï¼‰:
```python

options = QwenChatOptions(
    enable_thinking=True,
)

# âœ… å¿…é¡»ä½¿ç”¨æµå¼è°ƒç”¨
async for update in agent.run_stream(query, additional_chat_options=options):
    print(update.text, end="", flush=True)
```

---

## ä¿®æ­£æ€»ç»“

### ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹ç±»å‹ | ä¿®æ”¹æ•°é‡ |
|-----|---------|---------|
| `README.md` | **ä»£ç ä¿®æ­£** | 3å¤„ |
| `æ–‡æ¡£ä¿®æ­£è®°å½•_æ€è€ƒæ¨¡å¼æµå¼çº¦æŸ_2026-01-29.md` | **æ–°å¢æ–‡æ¡£** | æœ¬æ–‡ä»¶ |

**æ€»è®¡**: 1ä¸ªæ–‡ä»¶ä¿®æ”¹ï¼ˆ3å¤„ï¼‰ï¼Œ1ä¸ªæ–‡ä»¶æ–°å¢

---

## æŠ€æœ¯æ¾„æ¸…

### æ€è€ƒæ¨¡å¼çš„æ­£ç¡®ä½¿ç”¨æ¨¡å¼

```python
# âœ… æ­£ç¡®æ¨¡å¼1ï¼šå®Œæ•´æµå¼è¾“å‡º
options = QwenChatOptions(
    enable_thinking=True,
    include_reasoning=True  # åŒ…å«æ€è€ƒè¿‡ç¨‹
)

async for update in agent.run_stream(query, additional_chat_options=options):
    if update.text:
        print(update.text, end="", flush=True)
```

```python
# âœ… æ­£ç¡®æ¨¡å¼2ï¼šéšè—æ€è€ƒè¿‡ç¨‹
options = QwenChatOptions(
    enable_thinking=True,
    include_reasoning=False  # ä¸æ˜¾ç¤ºæ€è€ƒï¼Œä½†ä»è®¡è´¹
)

async for update in agent.run_stream(query, additional_chat_options=options):
    # åªè¾“å‡ºæœ€ç»ˆç­”æ¡ˆï¼Œæ€è€ƒè¿‡ç¨‹è¢«è¿‡æ»¤
    if update.text:
        print(update.text, end="", flush=True)
```

```python
# âŒ é”™è¯¯æ¨¡å¼ï¼šéæµå¼è°ƒç”¨
options = QwenChatOptions(enable_thinking=True)
result = await agent.run(query, additional_chat_options=options)
# é”™è¯¯: parameter.enable_thinking must be set to false for non-streaming calls
```

---

## APIçº¦æŸè§„åˆ™

### DashScope Generation.call() å‚æ•°çº¦æŸçŸ©é˜µ

| enable_thinking | stream | ç»“æœ |
|----------------|--------|------|
| `False` | `False` | âœ… æ­£å¸¸ |
| `False` | `True` | âœ… æ­£å¸¸ |
| `True` | `False` | âŒ **HTTP 400** |
| `True` | `True` | âœ… æ­£å¸¸ |

**ç»“è®º**ï¼š`enable_thinking=True` æ—¶ï¼Œ`stream` å¿…é¡»ä¸º `True`

---

## å®ç°å±‚é¢çš„é˜²æŠ¤

### åœ¨QwenChatClientä¸­çš„æ£€æµ‹

æ ¹æ®è®¾è®¡æ–‡æ¡£ï¼Œæˆ‘ä»¬åº”è¯¥åœ¨ `_inner_get_response` æ–¹æ³•ä¸­æ£€æµ‹å¹¶æŠ›å‡ºå¼‚å¸¸ï¼š

```python
async def _inner_get_response(self, messages, **options):
    """éæµå¼å“åº”æ–¹æ³•"""

    # ğŸ”¥ å…³é”®æ£€æŸ¥ï¼šæ€è€ƒæ¨¡å¼å¿…é¡»ä½¿ç”¨æµå¼
    if options.get("enable_thinking"):
        raise ThinkingModeRequiresStreamError(
            "å¯ç”¨æ€è€ƒæ¨¡å¼(enable_thinking=True)æ—¶å¿…é¡»ä½¿ç”¨æµå¼å“åº”ã€‚"
            "è¯·ä½¿ç”¨get_streaming_response()æ–¹æ³•æˆ–Agent.run_stream()ã€‚"
            "åŸå› :æ€è€ƒè¿‡ç¨‹é•¿åº¦ä¸å¯æ§,éæµå¼è°ƒç”¨ä¼šå¯¼è‡´HTTPè¶…æ—¶ã€‚"
        )

    # ... æ­£å¸¸çš„éæµå¼è°ƒç”¨é€»è¾‘
```

è¿™æ ·å³ä½¿ç”¨æˆ·è¯¯ç”¨ `agent.run()`ï¼Œä¹Ÿä¼šå¾—åˆ°æ¸…æ™°çš„é”™è¯¯æç¤ºï¼Œè€Œéç¥ç§˜çš„400é”™è¯¯ã€‚

---

## éªŒè¯æ¸…å•

ä¿®æ”¹å®Œæˆåï¼ŒéªŒè¯ä»¥ä¸‹å†…å®¹ï¼š

- [x] âœ… æ‰€æœ‰ `enable_thinking=True` çš„ç¤ºä¾‹éƒ½ä½¿ç”¨ `run_stream()`
- [x] âœ… éæµå¼ç¤ºä¾‹éƒ½ä¸åŒ…å« `enable_thinking=True`
- [x] âœ… æ·»åŠ äº†æ˜ç¡®çš„è­¦å‘Šè¯´æ˜
- [x] âœ… æ•…éšœæ’æŸ¥éƒ¨åˆ†ä¿æŒä¸€è‡´
- [x] âœ… æ–‡æ¡£ç«‹åœºä¸€è‡´ï¼šæ€è€ƒæ¨¡å¼å¿…é¡»æµå¼

---

## ç›¸å…³æ–‡æ¡£ä½ç½®

### README.md

1. **ç¬¬88-106è¡Œ**ï¼šè‡ªå®šä¹‰Chat Clientä¼˜åŠ¿ç¤ºä¾‹
   - ä¿®æ”¹ï¼šç§»é™¤ `enable_thinking=True`ï¼Œæ·»åŠ æ³¨é‡Šè¯´æ˜

2. **ç¬¬318-351è¡Œ**ï¼šå¯ç”¨æ€è€ƒæ¨¡å¼ç¤ºä¾‹
   - ä¿®æ”¹ï¼šæ”¹ç”¨ `run_stream()`ï¼Œæ·»åŠ è­¦å‘Šå’ŒåŸå› è¯´æ˜

   - ä¿®æ”¹ï¼šæ·»åŠ å®Œæ•´çš„æµå¼è°ƒç”¨ä»£ç 

4. **ç¬¬430-443è¡Œ**ï¼šæ•…éšœæ’æŸ¥ - é—®é¢˜1
   - ä¿æŒä¸å˜ï¼šå·²ç»æ˜¯æ­£ç¡®çš„

### å…¶ä»–æ–‡æ¡£

- `APIç«¯ç‚¹æŠ€æœ¯è¯´æ˜.md` ç¬¬303è¡Œï¼šâœ… å·²ç»ä½¿ç”¨ `run_stream()`ï¼ˆæ­£ç¡®ï¼‰
- `éœ€æ±‚è¯„ä¼°ä¸è®¾è®¡æ–‡æ¡£.md` ç¬¬110è¡Œï¼šâœ… å·²æ˜ç¡®çº¦æŸï¼ˆæ­£ç¡®ï¼‰
- `å¿«é€Ÿå¼€å§‹æŒ‡å—.md` ç¬¬146-152è¡Œï¼šâœ… å·²å®šä¹‰å¼‚å¸¸ç±»ï¼ˆæ­£ç¡®ï¼‰

---

## ç»éªŒæ•™è®­

### æœ¬æ¬¡é”™è¯¯çš„æ ¹æœ¬åŸå› 

1. **ç¤ºä¾‹ä»£ç ä¸æŠ€æœ¯çº¦æŸè„±èŠ‚**ï¼šå†™ç¤ºä¾‹æ—¶æ²¡æœ‰ä¸¥æ ¼éµå¾ªAPIçº¦æŸ
2. **æ–‡æ¡£å†…éƒ¨çŸ›ç›¾**ï¼šç¤ºä¾‹éƒ¨åˆ†å’Œæ•…éšœæ’æŸ¥éƒ¨åˆ†è¯´æ³•ä¸ä¸€
3. **ç¼ºå°‘è­¦å‘Šæ ‡è¯†**ï¼šæ²¡æœ‰åœ¨ç¤ºä¾‹ä»£ç å‰æ˜ç¡®è­¦å‘Šçº¦æŸ

### é˜²èŒƒæªæ–½

1. âœ… **å¼ºåˆ¶æ€§è­¦å‘Š**ï¼šåœ¨æ‰€æœ‰æ¶‰åŠ `enable_thinking` çš„ç¤ºä¾‹å‰æ·»åŠ è­¦å‘Š
2. âœ… **ä»£ç ä¸€è‡´æ€§æ£€æŸ¥**ï¼šæ‰€æœ‰ç¤ºä¾‹ä»£ç å¿…é¡»å¯è¿è¡Œï¼Œä¸èƒ½æœ‰é”™è¯¯
3. âœ… **çº¦æŸæ–‡æ¡£åŒ–**ï¼šå°†APIçº¦æŸæ˜ç¡®å†™åœ¨æ˜¾çœ¼ä½ç½®
4. âœ… **å®ç°å±‚é˜²æŠ¤**ï¼šåœ¨ä»£ç ä¸­æ£€æµ‹å¹¶æŠ›å‡ºæ¸…æ™°çš„å¼‚å¸¸

### æœªæ¥å»ºè®®

1. **Phase 2å®æ–½æ—¶**ï¼šä¸¥æ ¼æŒ‰ç…§ä¿®æ­£åçš„ç¤ºä¾‹å®ç°
2. **æµ‹è¯•éªŒè¯**ï¼šç¼–å†™æµ‹è¯•ç”¨ä¾‹éªŒè¯éæµå¼+æ€è€ƒæ¨¡å¼ç¡®å®ä¼šæŠ¥é”™
3. **æ–‡æ¡£å®¡æŸ¥**ï¼šä»£ç å®¡æŸ¥æ—¶åŒæ—¶å®¡æŸ¥ç¤ºä¾‹ä»£ç çš„æ­£ç¡®æ€§

---

## æŠ€æœ¯å‚è€ƒ

### DashScopeå®˜æ–¹æ–‡æ¡£

1. [é”™è¯¯ç å‚è€ƒ](https://www.alibabacloud.com/help/en/model-studio/error-code)
   - åŒ…å« `enable_thinking` å¿…é¡»æµå¼çš„è¯´æ˜

2. [æ–‡æœ¬ç”ŸæˆAPI](https://www.alibabacloud.com/help/en/model-studio/text-generation)
   - å‚æ•°çº¦æŸè¯´æ˜

3. [æµå¼è¾“å‡º](https://www.alibabacloud.com/help/en/model-studio/stream)
   - `incremental_output` å‚æ•°è¯´æ˜

### æœ¬åœ°è®¾è®¡æ–‡æ¡£

- `éœ€æ±‚è¯„ä¼°ä¸è®¾è®¡æ–‡æ¡£.md` - ç¬¬110è¡ŒæŠ€æœ¯æŒ‘æˆ˜
- `APIç«¯ç‚¹æŠ€æœ¯è¯´æ˜.md` - å®Œæ•´çš„APIå¯¹æ¯”
- `å¿«é€Ÿå¼€å§‹æŒ‡å—.md` - å¼‚å¸¸å®šä¹‰
- `README.md` - ä½¿ç”¨ç¤ºä¾‹

---

## åç»­è¡ŒåŠ¨

### Phase 1å®ç°æ—¶æ³¨æ„

åœ¨å®ç° `qwen_client.py` æ—¶ï¼š

```python
class QwenChatClient(BaseChatClient):
    async def _inner_get_response(self, messages, **options):
        """éæµå¼å“åº”"""

        # âœ… å¿…é¡»æ·»åŠ è¿™ä¸ªæ£€æŸ¥
        if options.get("enable_thinking"):
            raise ThinkingModeRequiresStreamError()

        # ... å…¶ä»–é€»è¾‘
```

### æµ‹è¯•ç”¨ä¾‹

```python
@pytest.mark.asyncio
async def test_thinking_mode_requires_stream():
    """éªŒè¯æ€è€ƒæ¨¡å¼å¿…é¡»æµå¼è°ƒç”¨"""
    client = QwenChatClient(model_id="qwen-plus")
    agent = ChatAgent(chat_client=client)

    options = QwenChatOptions(enable_thinking=True)

    # âœ… åº”è¯¥æŠ›å‡ºå¼‚å¸¸
    with pytest.raises(ThinkingModeRequiresStreamError):
        await agent.run("æµ‹è¯•", additional_chat_options=options)

    # âœ… æµå¼è°ƒç”¨åº”è¯¥æ­£å¸¸
    async for update in agent.run_stream("æµ‹è¯•", additional_chat_options=options):
        pass  # æ­£å¸¸æ‰§è¡Œ
```

---

**ä¿®æ­£å®Œæˆæ—¶é—´**: 2026-01-29 16:10
**å®¡æŸ¥äºº**: AI Assistant + ç”¨æˆ·
**çŠ¶æ€**: âœ… å·²å®Œæˆ

**ä¸‹ä¸€æ­¥**: Phase 1å®ç°æ—¶ä¸¥æ ¼éµå¾ªä¿®æ­£åçš„è®¾è®¡
