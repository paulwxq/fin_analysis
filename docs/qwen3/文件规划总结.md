# Qwen3 Chat Client - 文件规划总结

## 需要编写的Python文件清单

本文档列出所有需要编写的Python文件、预计代码行数、复杂度和开发优先级。

---

## 核心实现文件 (7个)

### 1. `config.py`

**目的**: 集中管理默认参数（除 API Key 外的可变项）

**预计行数**: 30-50行

**复杂度**: ⭐ (简单)

**内容**:
```python
- DEFAULT_MODEL_ID
- DEFAULT_TEMPERATURE
- DEFAULT_MAX_TOKENS
- DEFAULT_TOP_P
- DEFAULT_ENABLE_SEARCH
- REQUEST_TIMEOUT_S
- MAX_RETRIES
```

**优先级**: P0 (最先实现)

---

### 2. `qwen_options.py`

**目的**: 类型安全的配置类定义

**预计行数**: 80-100行

**复杂度**: ⭐ (简单)

**内容**:
```python
- QwenChatOptions (TypedDict)          # 推理模型配置
- QwenVLChatOptions (TypedDict)        # 视觉模型配置
- 字段说明注释
- 导入 ChatOptions from agent_framework
```

**依赖**:
- `typing` (标准库)
- `agent_framework`

**优先级**: P0 (最先实现)

---

### 2. `exceptions.py`

**目的**: 自定义异常类

**预计行数**: 60-80行

**复杂度**: ⭐ (简单)

**内容**:
```python
- QwenAPIError                         # API错误基类
- ThinkingModeRequiresStreamError      # 思考模式必须流式
- UnsupportedParameterError            # 不支持的参数
- RateLimitError                       # 限流错误
```

**依赖**: 无

**优先级**: P0 (最先实现)

---

### 3. `utils.py`

**目的**: 共享工具函数

**预计行数**: 150-200行

**复杂度**: ⭐⭐ (中等)

**内容**:
```python
def map_finish_reason(reason: str) -> FinishReason
    """映射结束原因"""

def extract_search_info(response) -> Dict
    """提取搜索信息"""

async def async_retry(func, max_retries=3, backoff=2.0)
    """异步重试装饰器"""
```

**依赖**:
- `agent_framework`
- `logging`
- `asyncio`

**优先级**: P0 (最先实现)

---

### 4. `qwen_client.py` ⭐⭐⭐ 核心文件

**目的**: 推理模型Chat Client (qwen-plus/qwen-max)

**预计行数**: 450-550行

**复杂度**: ⭐⭐⭐⭐ (高)

**类结构**:
```python
class QwenChatClient(BaseChatClient[QwenChatOptions]):
    """
    阿里云Qwen推理模型封装
    支持: qwen-plus, qwen-max
    """

    # 构造与初始化 (约50行)
    ENDPOINTS: ClassVar[Dict[str, str]]
    def __init__(self, model_id, api_key, **kwargs)

    # 消息转换 (约80行)
    def _convert_messages(self, messages) -> List[Dict]
    def _convert_role(self, role: Role) -> str

    # 请求构建 (约100行)
    def _build_request_params(self, messages, options) -> Dict
    def _merge_options(self, default, override) -> Dict

    # 非流式响应 (约100行)
    async def _inner_get_response(self, messages, **options) -> ChatResponse
    def _parse_response(self, response) -> ChatResponse

    # 流式响应 (约150行) 🔥 最复杂
    async def _inner_get_streaming_response(self, messages, **options) -> AsyncIterable
    def _create_stream_producer(self, params) -> Callable

    # 辅助方法 (约50行)
    def _validate_thinking_mode(self, options)
    def _log_token_usage(self, usage: UsageDetails)

    # 清理 (约10行)
    def __del__(self)
```

**关键技术点**:
1. ✅ 异步桥接 (线程池 + asyncio队列)
2. ✅ 思考模式检测与处理
3. ✅ 联网搜索支持
4. ✅ 强制 `incremental_output=True`
5. ✅ Token统计日志

**依赖**:
- `agent_framework` (BaseChatClient, ChatResponse, ChatResponseUpdate等)
- `dashscope` (Generation)
- `asyncio`, `threading`, `logging`

**优先级**: P0 (核心功能)

**预计开发时间**: 8小时

---

### 5. `qwen_vl_client.py` ⭐⭐⭐ 核心文件

**目的**: 视觉模型Chat Client (qwen3-vl-plus/qwen-vl-max)

**预计行数**: 550-650行

**复杂度**: ⭐⭐⭐⭐⭐ (非常高)

**类结构**:
```python
class QwenVLChatClient(BaseChatClient[QwenVLChatOptions]):
    """
    阿里云Qwen视觉模型封装
    支持: qwen3-vl-plus, qwen-vl-max
    """

    # 构造与初始化 (约50行)
    def __init__(self, model_id, api_key, **kwargs)

    # 多模态内容处理 (约200行) 🔥 最复杂
    def _process_content_item(self, item: Any) -> Dict[str, str]
        """转换单个Content对象"""
        # - 检测文本 (TextContent, str)
        # - 检测图片 (ImageContent, DataContent, UriContent)
        # - 处理URL格式
        # - 处理Base64格式
        # - 兜底处理

    def _convert_messages(self, messages) -> List[Dict]
        """转换为DashScope多模态格式"""

    def _validate_image_format(self, image_data: str) -> bool
        """验证图片格式"""

    # 请求构建 (约80行)
    def _build_request_params(self, messages, options) -> Dict

    # 非流式响应 (约100行)
    async def _inner_get_response(self, messages, **options) -> ChatResponse
    def _parse_vl_response(self, response) -> ChatResponse

    # 流式响应 (约120行)
    async def _inner_get_streaming_response(self, messages, **options) -> AsyncIterable

    # 辅助方法 (约50行)
```

**关键技术点**:
1. ✅ 复杂的多模态消息转换
2. ✅ 健壮的类型检测（鸭子类型）
3. ✅ 图片格式验证（URL/Base64）
4. ✅ 禁用不支持的参数（enable_search）

**依赖**:
- `agent_framework`
- `dashscope` (MultiModalConversation)
- `asyncio`, `threading`, `logging`
- `base64` (可选，用于图片编码)

**优先级**: P1 (重要功能)

**预计开发时间**: 8小时

---

### 6. `__init__.py`

**目的**: 包导出和版本管理

**预计行数**: 30-40行

**复杂度**: ⭐ (简单)

**内容**:
```python
"""
Qwen3 Chat Client for Microsoft Agent Framework
阿里云通义千问Qwen3系列模型的MAF集成
"""

__version__ = "1.0.0"
__author__ = "Your Team"

# 导出主要类
from .qwen_client import QwenChatClient
from .qwen_vl_client import QwenVLChatClient
from .qwen_options import QwenChatOptions, QwenVLChatOptions
from .exceptions import (
    QwenAPIError,
    ThinkingModeRequiresStreamError,
    UnsupportedParameterError,
    RateLimitError,
)
from .utils import (
    map_finish_reason,
)

__all__ = [
    "QwenChatClient",
    "QwenVLChatClient",
    "QwenChatOptions",
    "QwenVLChatOptions",
    "QwenAPIError",
    "ThinkingModeRequiresStreamError",
    "UnsupportedParameterError",
    "RateLimitError",
]
```

**优先级**: P0 (与其他文件同步)

---

## 测试文件 (4个)

### 7. `tests/__init__.py`

**预计行数**: 5-10行

**复杂度**: ⭐ (简单)

---

### 8. `tests/test_qwen_client.py`

**预计行数**: 300-400行

**复杂度**: ⭐⭐⭐ (中高)

**测试用例**:
```python
class TestQwenChatClient:
    def test_init()
    def test_message_conversion_simple()
    def test_message_conversion_multiRole()

    @pytest.mark.asyncio
    async def test_basic_chat()
    async def test_streaming_response()
    async def test_thinking_mode_enabled()
    async def test_thinking_mode_non_stream_error()
    async def test_search_enabled()
    async def test_token_usage_tracking()
    async def test_error_handling_400()
    async def test_error_handling_429()
    async def test_error_handling_500()

class TestQwenChatClientAdvanced:
    async def test_retry_mechanism()
```

**优先级**: P0

**预计开发时间**: 2小时

---

### 9. `tests/test_qwen_vl_client.py`

**预计行数**: 350-450行

**复杂度**: ⭐⭐⭐⭐ (高)

**测试用例**:
```python
class TestQwenVLChatClient:
    def test_init()
    def test_process_content_text()
    def test_process_content_image_url()
    def test_process_content_image_base64()
    def test_process_content_mixed()
    def test_multimodal_message_conversion()

    @pytest.mark.asyncio
    async def test_image_url_input()
    async def test_image_base64_input()
    async def test_text_only_input()
    async def test_enable_search_raises_error()
    async def test_streaming_multimodal()
```

**优先级**: P1

**预计开发时间**: 2小时

---

### 10. `tests/test_integration.py`

**预计行数**: 200-300行

**复杂度**: ⭐⭐⭐ (中高)

**测试用例**:
```python
class TestMAFIntegration:
    @pytest.mark.asyncio
    async def test_with_chat_agent()
    async def test_middleware_logging()
    async def test_middleware_tracing()
    async def test_multi_turn_conversation()
    async def test_tool_calling()
    async def test_mixed_model_workflow()
```

**优先级**: P1

**预计开发时间**: 2小时

---

## 示例文件 (4个)

### 11. `examples/basic_chat.py`

**预计行数**: 50-70行

**复杂度**: ⭐ (简单)

**内容**: 演示基础对话

---

### 12. `examples/thinking_mode.py`

**预计行数**: 80-100行

**复杂度**: ⭐⭐ (中等)


---

### 13. `examples/search_enhanced.py`

**预计行数**: 60-80行

**复杂度**: ⭐⭐ (中等)

**内容**: 演示联网搜索和引用提取

---

### 14. `examples/vision_analysis.py`

**预计行数**: 100-120行

**复杂度**: ⭐⭐⭐ (中高)

**内容**: 演示K线图分析

---

## 统计总结

### 核心代码

| 文件 | 预计行数 | 复杂度 | 优先级 | 开发时间 |
|-----|---------|--------|-------|----------|
| `qwen_options.py` | 80-100 | ⭐ | P0 | 1h |
| `exceptions.py` | 60-80 | ⭐ | P0 | 1h |
| `utils.py` | 150-200 | ⭐⭐ | P0 | 2h |
| `qwen_client.py` | 450-550 | ⭐⭐⭐⭐ | P0 | 8h |
| `qwen_vl_client.py` | 550-650 | ⭐⭐⭐⭐⭐ | P1 | 8h |
| `__init__.py` | 30-40 | ⭐ | P0 | 0.5h |
| **小计** | **1,320-1,620** | - | - | **20.5h** |

### 测试代码

| 文件 | 预计行数 | 开发时间 |
|-----|---------|----------|
| `tests/test_qwen_client.py` | 300-400 | 2h |
| `tests/test_qwen_vl_client.py` | 350-450 | 2h |
| `tests/test_integration.py` | 200-300 | 2h |
| **小计** | **850-1,150** | **6h** |

### 示例代码

| 文件 | 预计行数 | 开发时间 |
|-----|---------|----------|
| `examples/basic_chat.py` | 50-70 | 0.5h |
| `examples/thinking_mode.py` | 80-100 | 0.5h |
| `examples/search_enhanced.py` | 60-80 | 0.5h |
| `examples/vision_analysis.py` | 100-120 | 1h |
| **小计** | **290-370** | **2.5h** |

### 总计

- **总代码行数**: 2,460-3,140行
- **总开发时间**: 29小时
- **核心文件数**: 6个
- **测试文件数**: 4个
- **示例文件数**: 4个
- **总文件数**: 14个

---

## 复杂度分析

### 最复杂的3个文件

1. **`qwen_vl_client.py`** (⭐⭐⭐⭐⭐)
   - 多模态消息转换逻辑复杂
   - 需要处理多种图片格式
   - 鸭子类型检测容易出错

2. **`qwen_client.py`** (⭐⭐⭐⭐)
   - 异步流式响应实现复杂
   - 思考模式字段处理
   - 线程池队列管理

3. **`tests/test_qwen_vl_client.py`** (⭐⭐⭐⭐)
   - 需要Mock多种Content类型
   - 测试用例覆盖面广

---

## 关键技术挑战

### 挑战1: 异步桥接

**问题**: DashScope SDK是同步的，MAF是异步的

**解决方案**: 使用 `asyncio.to_thread` + 线程池队列

**影响文件**: `qwen_client.py`, `qwen_vl_client.py`

**预计调试时间**: 2小时

---

### 挑战2: 多模态消息转换

**问题**: MAF的Content类型需转换为DashScope格式

**解决方案**: 编写健壮的类型检测逻辑

**影响文件**: `qwen_vl_client.py`

**预计调试时间**: 3小时

---

### 挑战3: 思考模式流式处理

**问题**: `reasoning_content` 字段需要特殊处理

**解决方案**: 检测字段并根据配置返回

**影响文件**: `qwen_client.py`

**预计调试时间**: 1小时

---

## 开发顺序建议

### 第1天 (Phase 1)

1. ✅ `qwen_options.py`
2. ✅ `exceptions.py`
3. ✅ `utils.py` (基础函数)
4. ✅ `__init__.py`

### 第2-3天 (Phase 2)

5. ✅ `qwen_client.py` (完整实现)
6. ✅ `tests/test_qwen_client.py` (基础测试)

### 第4-5天 (Phase 3)

7. ✅ `qwen_vl_client.py` (完整实现)
8. ✅ `tests/test_qwen_vl_client.py` (基础测试)

### 第6天 (Phase 4)

9. ✅ `tests/test_integration.py`
10. ✅ 完善所有测试

### 第7天 (Phase 5)

11. ✅ 所有示例文件
12. ✅ 文档完善

---

## 质量标准

### 代码质量

- [ ] 所有函数有类型标注
- [ ] 所有公开API有docstring (Google风格)
- [ ] 遵循PEP 8
- [ ] 通过MyPy检查 (`mypy --strict`)
- [ ] 通过pylint检查 (评分 > 9.0)

### 测试质量

- [ ] 单元测试覆盖率 > 80%
- [ ] 所有异步函数测试超时
- [ ] 所有异常路径有测试
- [ ] Mock所有外部API调用

### 文档质量

- [ ] README完整可读
- [ ] 所有示例可运行
- [ ] API参考文档生成

---

## 下一步行动

1. **立即**: 复制本文档到项目Wiki
2. **今天**: 开始Phase 1开发
3. **本周**: 完成Phase 1-2
4. **下周**: 完成Phase 3-5

---

**最后更新**: 2026-01-29
**文档版本**: v1.0
