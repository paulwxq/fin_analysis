# Qwen3 Chat Client - 快速开始指南

> **⏱️ 5分钟快速上手** | **🎯 从评估到实现的完整路径**

---

## 📋 当前状态

✅ **Phase 0: 需求评估完成** (2026-01-29)

已完成的文档：
- ✅ 需求评估与设计文档（详细设计）
- ✅ 文件规划总结（14个文件，2,460-3,140行代码）
- ✅ 开发任务清单（5个阶段，30小时工作量）
- ✅ 项目架构图（完整的架构和数据流）
- ✅ README（使用指南）
- ✅ 本快速开始指南

**下一步**: 开始 Phase 1 - 基础架构搭建

---

## 🚀 立即开始 (今天可以做的)

### Step 1: 安装依赖 (5分钟)

编辑 `pyproject.toml`，在 `dependencies` 部分添加：

```toml
[project]
dependencies = [
    # ... 现有依赖 ...
    "dashscope>=1.20.0",
]

[project.optional-dependencies]
dev = [
    "pytest>=8.0.0",
    "pytest-asyncio>=0.25.0",
    "pytest-mock>=3.15.0",
    "mypy>=1.15.0",
]
```

运行安装：
```bash
uv sync
```

验证安装：
```bash
python -c "import dashscope; print('✅ DashScope安装成功')"
```

### Step 2: 验证环境变量 (2分钟)

确认 `.env` 中有（只放 API Key，其他参数写入 `config.py`）：
```bash
DASHSCOPE_API_KEY=sk-xxxxxxxxxxxxx
```

验证：
```bash
python -c "import os; from dotenv import load_dotenv; load_dotenv(); assert os.getenv('DASHSCOPE_API_KEY'), '❌ API Key未设置'; print('✅ API Key已配置')"
```

### Step 3: 创建文件框架 (5分钟)

运行以下命令创建所有必需的文件：

```bash
cd qwen3

# 创建核心文件
touch __init__.py config.py qwen_options.py exceptions.py utils.py
touch qwen_client.py qwen_vl_client.py

# 创建测试目录和文件
mkdir -p tests
touch tests/__init__.py
touch tests/test_qwen_client.py
touch tests/test_qwen_vl_client.py
touch tests/test_integration.py

# 创建示例目录和文件
mkdir -p examples
touch examples/basic_chat.py
touch examples/thinking_mode.py
touch examples/search_enhanced.py
touch examples/vision_analysis.py

# 创建测试数据目录
mkdir -p tests/fixtures
```

验证文件结构：
```bash
tree qwen3/
```

应该看到：
```
qwen3/
├── README.md
├── 需求评估与设计文档.md
├── 开发任务清单.md
├── 文件规划总结.md
├── 项目架构图.md
├── 快速开始指南.md
├── __init__.py
├── config.py
├── qwen_options.py
├── exceptions.py
├── utils.py
├── qwen_client.py
├── qwen_vl_client.py
├── tests/
│   ├── __init__.py
│   ├── test_qwen_client.py
│   ├── test_qwen_vl_client.py
│   ├── test_integration.py
│   └── fixtures/
└── examples/
    ├── basic_chat.py
    ├── thinking_mode.py
    ├── search_enhanced.py
    └── vision_analysis.py
```

---

## 📝 开发顺序 (按优先级)

### Phase 1: 基础架构 (4小时)

**今天完成这些文件**：

#### 1.1 `config.py` (配置管理)

```python
"""全局配置"""

# 默认模型与推理参数
DEFAULT_MODEL_ID = "qwen-plus"          # 默认模型
DEFAULT_TEMPERATURE = 0.7               # 温度
DEFAULT_MAX_TOKENS = 2000               # 最大输出 Token
DEFAULT_TOP_P = 0.9                     # Top-p
DEFAULT_ENABLE_SEARCH = True            # 默认是否启用搜索

# 网络与重试
REQUEST_TIMEOUT_S = 60                  # 请求超时（秒）
MAX_RETRIES = 3                         # 最大重试次数
```

#### 1.2 `exceptions.py` (最简单)

```python
"""自定义异常类"""

class QwenAPIError(Exception):
    """DashScope API调用错误基类"""
    pass

class ThinkingModeRequiresStreamError(ValueError):
    """思考模式必须使用流式调用"""
    def __init__(self):
        super().__init__(
            "enable_thinking=True时必须使用流式响应。"
            "请使用get_streaming_response()或Agent.run_stream()。"
        )

class UnsupportedParameterError(ValueError):
    """模型不支持的参数"""
    pass

class RateLimitError(QwenAPIError):
    """API限流错误 (HTTP 429)"""
    pass
```

#### 1.2 `qwen_options.py` (类型定义)

```python
"""Qwen模型配置类型定义"""
from typing import TypedDict, NotRequired, Literal
from agent_framework import ChatOptions

class QwenChatOptions(ChatOptions):
    """Qwen文本模型完整配置"""

    # 思维链控制
    enable_thinking: NotRequired[bool]          # 思考总开关

    # 搜索与工具
    enable_search: NotRequired[bool]            # 原生搜索增强

    # 随机性控制
    seed: NotRequired[int]                      # 随机种子
    repetition_penalty: NotRequired[float]      # 重复惩罚

    # 调试选项
    include_reasoning: NotRequired[bool]        # 是否返回思考过程

class QwenVLChatOptions(ChatOptions):
    """Qwen视觉模型配置"""

    # 视觉模型专用
    min_pixels: NotRequired[int]                # 最小分辨率
    max_pixels: NotRequired[int]                # 最大分辨率

    # 注意：不支持 enable_search
```

#### 1.3 `utils.py` (工具函数)

```python
"""工具函数"""
import logging
from typing import Optional
from agent_framework import FinishReason, UsageDetails

logger = logging.getLogger(__name__)

def map_finish_reason(reason: Optional[str]) -> Optional[FinishReason]:
    """映射DashScope的结束原因到MAF格式"""
    if not reason or reason == "null":
        return None
    if reason == "stop":
        return FinishReason.STOP
    if reason == "length":
        return FinishReason.LENGTH
    if reason == "tool_calls":
        return FinishReason.TOOL_CALLS
    return FinishReason.STOP
```

#### 1.4 `__init__.py` (包导出)

```python
"""
Qwen3 Chat Client for Microsoft Agent Framework
阿里云通义千问Qwen3系列模型的MAF原生集成
"""

__version__ = "1.0.0"
__author__ = "Your Team"

# 核心类（待实现）
# from .qwen_client import QwenChatClient
# from .qwen_vl_client import QwenVLChatClient

# 配置类
from .qwen_options import QwenChatOptions, QwenVLChatOptions

# 异常类
from .exceptions import (
    QwenAPIError,
    ThinkingModeRequiresStreamError,
    UnsupportedParameterError,
    RateLimitError,
)

# 工具函数
from .utils import (
    map_finish_reason,
)

__all__ = [
    # "QwenChatClient",      # Phase 2实现
    # "QwenVLChatClient",    # Phase 3实现
    "QwenChatOptions",
    "QwenVLChatOptions",
    "QwenAPIError",
    "ThinkingModeRequiresStreamError",
    "UnsupportedParameterError",
    "RateLimitError",
]
```

**完成Phase 1后验证**：
```bash
cd qwen3
python -c "from qwen_options import QwenChatOptions; print('✅ Phase 1完成')"
```

---

### Phase 2: 推理模型实现 (8小时)

**本周完成**：`qwen_client.py`

**骨架代码**（先实现这个框架）：

```python
"""Qwen推理模型Chat Client"""
from __future__ import annotations

import os
import asyncio
import logging
import threading
from typing import Any, AsyncIterable, List, Dict, Optional, Sequence
from http import HTTPStatus

# MAF导入
from agent_framework import (
    BaseChatClient,
    ChatResponse,
    ChatResponseUpdate,
    ChatMessage,
    Role,
    TextContent,
)

# DashScope导入
import dashscope
from dashscope.api_entities.dashscope_response import GenerationResponse

# 本地导入
from .qwen_options import QwenChatOptions
from .exceptions import ThinkingModeRequiresStreamError
from .utils import map_finish_reason

logger = logging.getLogger(__name__)


class QwenChatClient(BaseChatClient[QwenChatOptions]):
    """
    Qwen推理模型Chat Client

    支持模型:
    - qwen-plus
    - qwen-max

    特性:
    - 联网搜索 (enable_search)
    - 流式响应
    """

    def __init__(
        self,
        model_id: str = "qwen-plus",
        api_key: Optional[str] = None,
        **default_options: Any,
    ):
        super().__init__(model_id=model_id)

        self.api_key = api_key or os.getenv("DASHSCOPE_API_KEY")
        if not self.api_key:
            raise ValueError("必须提供API Key")

        self.default_options = default_options
        logger.info(f"QwenChatClient初始化: model={model_id}")

    def _convert_messages(
        self,
        messages: Sequence[ChatMessage]
    ) -> List[Dict[str, Any]]:
        """TODO: 转换消息格式"""
        raise NotImplementedError("Phase 2实现")

    async def _inner_get_response(
        self,
        messages: Sequence[ChatMessage],
        **options: Any,
    ) -> ChatResponse:
        """TODO: 非流式响应"""
        raise NotImplementedError("Phase 2实现")

    async def _inner_get_streaming_response(
        self,
        messages: Sequence[ChatMessage],
        **options: Any,
    ) -> AsyncIterable[ChatResponseUpdate]:
        """TODO: 流式响应"""
        raise NotImplementedError("Phase 2实现")
        yield  # 占位符


# 简单测试
if __name__ == "__main__":
    client = QwenChatClient()
    print("✅ QwenChatClient可以实例化")
```

**测试骨架**：
```bash
python qwen_client.py
```

---

### Phase 3: 视觉模型实现 (8小时)

**下周完成**：`qwen_vl_client.py`

（类似结构，但需要实现 `_process_content_item`）

---

### Phase 4: 测试 (6小时)

**编写测试用例**

基础测试模板：
```python
# tests/test_qwen_client.py
import pytest
from qwen3 import QwenChatClient, QwenChatOptions

@pytest.mark.asyncio
async def test_client_initialization():
    """测试客户端初始化"""
    client = QwenChatClient(
        model_id="qwen-plus",
        api_key="test-key"
    )
    assert client.model_id == "qwen-plus"
    assert client.api_key == "test-key"

# TODO: 更多测试用例...
```

---

## 🎯 里程碑检查

### M1: Phase 1完成 ✅

- [ ] 所有文件已创建
- [ ] `qwen_options.py` 实现完成
- [ ] `exceptions.py` 实现完成
- [ ] `utils.py` 基础函数实现
- [ ] `__init__.py` 正确导出
- [ ] 可以 `import qwen3` 无错误

**验证命令**:
```bash
python -c "from qwen3 import QwenChatOptions, QwenAPIError; print('✅ M1达成')"
```

### M2: Phase 2完成 (本周目标)

- [ ] `qwen_client.py` 实现完成
- [ ] 基础对话功能正常
- [ ] 流式响应正常
- [ ] 思考模式可用
- [ ] 联网搜索可用
- [ ] 基础测试通过

**验证命令**:
```bash
pytest tests/test_qwen_client.py -v
```

### M3: Phase 3完成 (下周目标)

- [ ] `qwen_vl_client.py` 实现完成
- [ ] 图片分析功能正常
- [ ] K线图识别可用
- [ ] 测试通过

### M4: 生产就绪

- [ ] 所有测试通过
- [ ] 覆盖率 > 80%
- [ ] 文档完善
- [ ] 示例可运行

---

## 📚 参考资料

**本地文档** (按阅读顺序):
1. `README.md` - 项目概览和使用指南
2. `需求评估与设计文档.md` - 详细设计
3. `开发任务清单.md` - 具体任务
4. `文件规划总结.md` - 文件清单
5. `项目架构图.md` - 架构和数据流
6. 本文档 - 快速开始

**外部文档**:
- [MAF官方文档](https://learn.microsoft.com/en-us/agent-framework)
- [DashScope API参考](https://www.alibabacloud.com/help/en/model-studio)
- `../docs/qwen/` 下的所有文档

---

## 🆘 遇到问题？

### 常见问题

**Q: `import dashscope` 失败？**
```bash
A: 运行 uv sync 重新安装依赖
```

**Q: API Key在哪里获取？**
```bash
A: 访问 https://dashscope.aliyuncs.com (中国站)
   或 https://dashscope-intl.aliyuncs.com (国际站)
```

**Q: Phase 2太复杂，从哪里开始？**
```bash
A: 先实现 _convert_messages() 方法
   然后实现 _inner_get_response() (非流式)
   最后实现流式响应
```

---

## ✅ 今天的行动清单

复制这个清单，逐项完成：

- [ ] ✅ 阅读本文档
- [ ] ✅ 在 `pyproject.toml` 添加 `dashscope` 依赖
- [ ] ✅ 运行 `uv sync` 安装依赖
- [ ] ✅ 验证 `DASHSCOPE_API_KEY` 环境变量
- [ ] ✅ 创建所有文件框架
- [ ] ✅ 实现 `exceptions.py`
- [ ] ✅ 实现 `qwen_options.py`
- [ ] ✅ 实现 `utils.py` 基础函数
- [ ] ✅ 实现 `__init__.py`
- [ ] ✅ 验证 `import qwen3` 成功
- [ ] ✅ 提交Git (如果使用版本控制)

**完成后**：
```bash
echo "🎉 Phase 1完成！可以开始Phase 2了！"
```

---

## 🚢 下一步

**Phase 1完成后**:
1. 开始实现 `qwen_client.py`
2. 参考 `docs/qwen/Qwen集成MS_Agent_Framework完整指南_v3最终版.md` 中的代码示例
3. 逐步实现每个方法
4. 边实现边测试

**有问题随时查看**:
- `开发任务清单.md` - 具体任务分解
- `项目架构图.md` - 理解数据流
- `需求评估与设计文档.md` - 深入设计细节

---

**祝开发顺利！🚀**

*最后更新: 2026-01-29*
