# 数据清洗规则说明书 (Data Cleaning Rules)

本文档定义了 A 股分时数据加载模块 (`data_infra`) 采用的数据清洗和验证规则。这些规则旨在过滤源数据中的计算错误、溢出值和格式异常，确保入库数据的质量和数据库稳定性。

## 1. 核心原则

*   **宁缺毋滥**：对于明显违反物理意义或市场规则的脏数据（如无穷大涨幅、负万亿成交额），一律视为坏行（Bad Row）直接跳过，而不是尝试修正。
*   **保护数据库**：所有数值必须在数据库字段定义的范围内，防止 `COPY` 命令因 `NumericValueOutOfRange` 导致整个事务回滚。
*   **记录在案**：所有被清洗掉的数据行都应在日志中以 WARNING 级别记录（或统计），文件状态可能因此标记为 WARNING。

## 2. 字段级校验规则

### 2.1 涨跌幅 (ChangePct) & 振幅 (Amplitude)
*   **问题背景**：源数据中存在因分母接近 0 而导致的极大值（如 `-7439285.29`），或直接为 `inf`/`nan`。
*   **数据库限制**：`NUMERIC(10, 4)`，最大绝对值 `999999.9999`。
*   **清洗规则**：
    *   **拒绝 NaN/Inf**：直接跳过。
    *   **阈值校验**：`abs(Value) > 10,000` (10,000%)。
    *   **理由**：A 股正常的分钟级涨跌幅不会超过 100倍。超过此阈值通常意味着复权计算错误。

### 2.2 成交额 (Amount)
*   **问题背景**：源数据中存在溢出的成交额（如 `-388万亿`）。
*   **数据库限制**：`NUMERIC(20, 4)`。
*   **清洗规则**：
    *   **拒绝 NaN/Inf**：直接跳过。
    *   **阈值校验**：`abs(Value) > 1,000,000,000,000` (1万亿)。
    *   **理由**：单只股票单分钟成交额不可能超过 1 万亿。

### 2.3 成交量 (Volume)
*   **问题背景**：源数据可能包含浮点数（`123.0`）或科学计数法（`1E6`），也可能出现极大异常值。
*   **数据库限制**：`BIGINT` (Signed 64-bit integer)。
*   **清洗规则**：
    *   **类型转换**：优先尝试 `int()`。若为浮点数，必须是整数（`123.0`），否则（`1.5`）跳过。
    *   **精度安全**：若使用浮点转换，值不得超过 `9e15`（2^53），防止精度丢失。
    *   **阈值校验**：`abs(Value) > 100,000,000,000` (1000亿)。

### 2.4 价格 (Open/Close/High/Low)
*   **清洗规则**：
    *   **非空校验**：必须存在。
    *   **拒绝 NaN/Inf**：直接跳过。
    *   **类型校验**：必须能解析为数字。
    *   **逻辑校验 (High/Low Check)**：在同一分钟内，必须满足 `High >= Low`。如果 `High < Low`，逻辑崩坏，视为坏行跳过。

### 2.5 时间 (Time)
*   **清洗规则**：
    *   **截断**：仅取前 19 位字符（忽略毫秒）。
    *   **格式校验**：必须符合 `YYYY-MM-DD HH:MM:SS`。

## 3. 典型脏数据案例 (用于测试)

| 文件 | 行号 (约) | 异常字段 | 值 | 判定结果 |
| :--- | :--- | :--- | :--- | :--- |
| `2006_1min.zip` / `sh600007` | 757 | Amplitude | `inf` | **跳过** (NaN/Inf 检查) |
| `2006_1min.zip` / `sz000008` | 65190 | ChangePct | `-7439285.29` | **跳过** (阈值检查) |
| `2006_1min.zip` / `sz000008` | 65190 | Amount | `-3884144...` | **跳过** (阈值检查) |

## 4. 配置项建议 (config.py)

```python
# Validation Thresholds
MAX_ABS_CHANGE_PCT = 10000.0  # 100倍
MAX_ABS_AMPLITUDE = 10000.0   # 100倍
MAX_ABS_AMOUNT = 1e12         # 1万亿
MAX_ABS_VOLUME = 1e11         # 1000亿
```
